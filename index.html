<!-- poll-static-google-sheets-mobile.html -->
<!doctype html>
<html lang="zh-Hans">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>ç­çº§æŠ•ç¥¨ â€” Poll</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    html,
    body {
      height: 100%;
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Sans CJK SC', 'PingFang SC', 'Microsoft YaHei', sans-serif;
      background: linear-gradient(180deg, #0f172a 0%, #071033 100%);
      color: #e6eef8;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px
    }

    .wrap {
      width: 100%;
      max-width: 600px
    }

    header {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 16px;
      text-align: center
    }

    .title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px
    }

    .sub {
      font-size: 12px;
      color: #9fb0d9
    }

    .grid {
      display: flex;
      flex-direction: column;
      gap: 14px;
      width: 100%
    }

    .card {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.01));
      backdrop-filter: blur(6px);
      padding: 14px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.6);
      display: flex;
      flex-direction: column;
      transition: transform .18s cubic-bezier(.2, .9, .3, 1), box-shadow .18s
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 28px rgba(2, 6, 23, 0.7)
    }

    .meta {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px
    }

    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      background: linear-gradient(135deg, #2b6cb0, #7f5af0);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      color: white
    }

    .name {
      font-size: 16px;
      font-weight: 700
    }

    .idsmall {
      font-size: 11px;
      color: #9fb0d9
    }

    .bar-wrap {
      height: 10px;
      background: rgba(255, 255, 255, 0.04);
      border-radius: 999px;
      overflow: hidden;
      margin: 12px 0
    }

    .bar {
      height: 100%;
      width: 0%;
      transition: width .9s cubic-bezier(.2, .9, .3, 1);
      background: linear-gradient(90deg, #7f5af0, #2b6cb0)
    }

    .votes {
      font-weight: 700;
      margin-top: 4px;
      font-size: 14px
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 700;
      background: #ffffff;
      color: #0b1220;
      box-shadow: 0 4px 14px rgba(17, 24, 39, 0.35);
      transition: transform .12s, box-shadow .12s;
      font-size: 14px
    }

    .btn:active {
      transform: translateY(1px)
    }

    .btn[disabled] {
      opacity: .6;
      cursor: default;
      transform: none
    }

    footer {
      margin-top: 18px;
      color: #9fb0d9;
      font-size: 12px;
      text-align: center
    }

    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      bottom: 20px;
      background: #0b1220;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      color: #cfe5ff;
      box-shadow: 0 8px 24px rgba(2, 6, 23, 0.6);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s, transform .18s
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0)
    }

    .celebrate {
      position: relative
    }

    .celebrate::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 12px;
      pointer-events: none;
      background: conic-gradient(from 110deg at 50% 0%, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0) 40%);
      mix-blend-mode: overlay;
      opacity: 0;
      transition: opacity .35s
    }

    .celebrate.active::after {
      opacity: 1
    }

    @media (min-width:480px) {
      .grid {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 16px
      }

      .card {
        flex: 1 1 calc(50% - 8px)
      }
    }

    @media (min-width:720px) {
      .card {
        flex: 1 1 calc(33.33% - 10px)
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">ç­çº§æŠ•ç¥¨</div>
      <div class="sub">æ¯ä¸ªè£…ç½®ä»…å¯æŠ•ä¸€ç¥¨ â€” èµ„æ–™å‚¨å­˜åœ¨ Google Sheets</div>
      <button id="refreshBtn" class="btn" style="margin-top:10px">åˆ·æ–°ç»“æœ</button>
    </header>
    <main>
      <div id="grid" class="grid"></div>
      <footer>å·²è¿æ¥åˆ° Google Sheetsã€‚è¯·ç¡®ä¿ Apps Script å·²éƒ¨ç½²ä¸”å…è®¸åŒ¿åè®¿é—®ã€‚</footer>
    </main>
  </div>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <script>
    // const GOOGLE_APPS_SCRIPT_URL = 'api/proxy';
    const GOOGLE_APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxDOJDkdABOLBlBjVhwnpNjlxh2l80oDTL3tgqo_j8gLsDgFzCds978XW7szNmML7RI/exec";
    const LOCAL_VOTE_KEY = 'poll_voted_participant_id_v1';
    const grid = document.getElementById('grid');
    const toastEl = document.getElementById('toast');
    const refreshBtn = document.getElementById('refreshBtn');

    function showToast(msg, timeout = 2800) { toastEl.textContent = msg; toastEl.classList.add('show'); clearTimeout(toastEl._t); toastEl._t = setTimeout(() => toastEl.classList.remove('show'), timeout); }
    function shortNameToInitials(name) { if (!name) return '?'; name = String(name).trim(); return name.length <= 2 ? name : name.slice(-2); }

    let dataCache = [];
    async function fetchResults() {
      try {
        const res = await fetch(GOOGLE_APPS_SCRIPT_URL);
        if (!res.ok) throw new Error(res.status);
        const json = await res.json(); dataCache = json; renderGrid(json); return json;
      } catch (err) { console.error(err); showToast('æ— æ³•è¯»å–ç»“æœ'); return []; }
    }

    function getTotalVotes(items) { return items.reduce((s, i) => s + (Number(i.votes) || 0), 0); }

    function renderGrid(items) {
      grid.innerHTML = ''; const total = Math.max(1, getTotalVotes(items)); const votedId = localStorage.getItem(LOCAL_VOTE_KEY);
      items.forEach(item => {
        const card = document.createElement('div'); card.className = 'card celebrate';
        const meta = document.createElement('div'); meta.className = 'meta';
        const avatar = document.createElement('div'); avatar.className = 'avatar'; avatar.textContent = shortNameToInitials(item.name);
        const info = document.createElement('div');
        const nameEl = document.createElement('div'); nameEl.className = 'name'; nameEl.textContent = item.name;
        const idEl = document.createElement('div'); idEl.className = 'idsmall'; idEl.textContent = item.id;
        info.appendChild(nameEl); info.appendChild(idEl); meta.appendChild(avatar); meta.appendChild(info);
        const barWrap = document.createElement('div'); barWrap.className = 'bar-wrap';
        const bar = document.createElement('div'); bar.className = 'bar'; const percent = Math.round((Number(item.votes) || 0) / total * 100);
        setTimeout(() => { bar.style.width = percent + '%'; }, 60); barWrap.appendChild(bar);
        const votesEl = document.createElement('div'); votesEl.className = 'votes'; votesEl.textContent = `${item.votes} ç¥¨ â€¢ ${percent}%`;
        const btn = document.createElement('button'); btn.className = 'btn'; btn.textContent = votedId ? (votedId === item.id ? 'å·²æŠ•ç¥¨' : 'å·²é”å®š') : 'æŠ•ç»™ä»–/å¥¹'; btn.disabled = !!votedId;
        btn.addEventListener('click', () => onVote(item.id, card));
        card.appendChild(meta); card.appendChild(barWrap); card.appendChild(votesEl); card.appendChild(btn);
        grid.appendChild(card);
      });
    }

    async function onVote(participantId, cardEl) {
      if (localStorage.getItem(LOCAL_VOTE_KEY)) { showToast('æ­¤è£…ç½®å·²æŠ•è¿‡ç¥¨'); return; }
      if (!confirm('ç¡®è®¤è¦æŠŠä½ çš„ä¸€ç¥¨æŠ•ç»™æ­¤äººå—ï¼Ÿæ¯ä¸ªè£…ç½®ä»…å¯æŠ•ä¸€æ¬¡ã€‚')) return;
      try {
        localStorage.setItem(LOCAL_VOTE_KEY, participantId); renderGrid(dataCache);
        const payload = { participantId };
        const res = await fetch(GOOGLE_APPS_SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!res.ok) throw new Error(res.status);
        const j = await res.json(); if (j.status !== 'success') throw new Error('æœåŠ¡å™¨å›åº”å¼‚å¸¸');
        cardEl.classList.add('active'); setTimeout(() => cardEl.classList.remove('active'), 1200);
        showToast('æŠ•ç¥¨æˆåŠŸ ğŸ‰'); await fetchResults();
      } catch (err) { console.error(err); localStorage.removeItem(LOCAL_VOTE_KEY); renderGrid(dataCache); showToast('æŠ•ç¥¨å¤±è´¥'); }
    }

    refreshBtn.addEventListener('click', () => fetchResults().then(() => showToast('å·²æ›´æ–°')));
    (async () => { showToast('æ­£åœ¨åŠ è½½ç»“æœ...'); await fetchResults(); showToast('å·²å–å¾—ç»“æœ'); })();
  </script>
</body>

</html>