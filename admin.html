<!doctype html>
<html lang="zh-Hans">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>投票设置指南</title>
  <link rel="stylesheet" href="css/admin.css">
</head>

<body>
  <div id="toast" class="toast"></div>

  <div class="wrap">
    <header>
      <h1>投票设置指南</h1>
      <p>按照以下步骤设置 Google Sheets 和 Apps Script</p>
    </header>

    <main>
      <section class="guide-section">
        <h2>步骤 1: 创建表格</h2>
        <p>新建 Google Sheets 表格，列标题为:</p>
        <code>ID | Name | Votes</code>
        <p>在下面填写参与者信息，Votes 初始填 0。以下为示范</p>
        <textarea readonly rows="7" class="copyCode">
ID	Name	Votes
participant1	陈晓民	0
participant2	煮源泉	0
participant3	重大而	0
participant4	离绘画	0
participant5	等小艾	0
participant6	张丽华	0
        </textarea>
        <button class="btn copyCode">点击复制示范表格</button>
      </section>

      <section class="guide-section">
        <h2>步骤 2: 添加 Apps Script</h2>
        <p>在菜单中选择 <em>扩展程序 → Apps Script</em>，复制以下代码到编辑器:</p>
        <textarea readonly rows="15" class="copyCode">

function doPost(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Sheet1");
  const data = JSON.parse(e.postData.contents);
  const participantId = data.participantId;

  const range = sheet.getDataRange().getValues();

  for (let i = 1; i < range.length; i++) {
    if (range[i][0] === participantId) {
      const currentVotes = range[i][2];
      sheet.getRange(i + 1, 3).setValue(currentVotes + 1);
      break;
    }
  }

  return ContentService
    .createTextOutput(JSON.stringify({ status: "success" }))
    .setMimeType(ContentService.MimeType.JSON);
}

function doGet() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Sheet1");
  const range = sheet.getDataRange().getValues();
  const results = [];

  for (let i = 1; i < range.length; i++) {
    results.push({
      id: range[i][0],
      name: range[i][1],
      votes: range[i][2]
    });
  }

  return ContentService
    .createTextOutput(JSON.stringify(results))
    .setMimeType(ContentService.MimeType.JSON);
}

        </textarea>
        <button class="btn copyCode">点击复制 Apps Script</button>
      </section>

      <section class="guide-section">
        <h2>步骤 3: 部署 Web 应用</h2>
        <p>在 Apps Script 页面选择 <em>部署 → 新建部署 → Web 应用程式</em></p>
        <p>执行身份: <strong>我自己</strong>, 允许访问者: <strong>任何人(匿名)</strong></p>
      </section>

      <section class="guide-section">
        <h2>步骤 4: 输入 /exec URL</h2>
        <input type="text" id="appsScriptURL" placeholder="粘贴你的 Apps Script /exec URL">
        <button id="saveURL">保存 URL</button>
      </section>

      <section class="guide-section">
        <p>保存后即可在投票页面使用。</p>
      </section>

    </main>
  </div>

  <a href="/">返回投票界面</a>
  <a href="/vote-result.html">返回投票界面</a>
  <script src="js/admin.js"></script>
</body>

</html>